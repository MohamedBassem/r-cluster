<html>
  <head>
    <link href="/assets/bootstrap.min.css" rel="stylesheet" >
  </head>
  <body>
    <div class="col-sm-12">
      <h1> R Script Console </h1>
    </div>
    <div class="container-fluid">
      <div class="form-horizontal" role="form">
        <form id="upload-files-form" enctype="multipart/form-data">
          <div class="form-group">
            <div class="col-sm-10">
              <input type="text" name="files" class="form-control" name="task-id" id="task-id" oninput="updateOutputLink()" placeholder="Task Id" />
            </div>
            <div class="col-sm-2">
              <input type="button" class="btn btn-default" id="generate-random-string" value="Generate Random String" />
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-10">
              <input type="file" class="form-control" id="upload-to-code-files" multiple/>
            </div>
            <div class="col-sm-2">
              <input type="button" class="btn btn-default" id="upload-to-code" value="Upload to Code Folder" />
            </div>
          </div>
        </form>
        <div class="form-group">
          <div class="col-sm-12"> 
            <textarea class="form-control" id="command-area" rows="22"disabled></textarea>
          </div>
        </div>
        <div class="form-group"> 
          <div class="col-sm-12">
            Output: <a id="output-link" href="http://localhost:5056/static//output" >http://localhost:5056/static//output</a>
          </div>
        </div>
        <div class="form-group"> 
          <div class="col-sm-11">
            <input type="text" class="form-control" id="command" />
          </div>
          <div class="col-sm-1">
            <input type="button" class="btn btn-default" id="send-command" value="Run" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="/assets/jquery.min.js"></script>
<script src="/assets/bootstrap.min.js"></script>
<script>

function updateOutputLink() {
  $("#output-link").html("http://localhost:5056/static/"+ $("#task-id").val() +"/output")
    $("#output-link").prop("href", "http://localhost:5056/static/"+ $("#task-id").val() +"/output")
}
$(document).ready(function() {

  $('#upload-to-code').click(function () {
    var formData = new FormData($('#upload-files-form')[0]);
    $.ajax({
      url: '/uploadcode',  
      type: 'POST',
      success: function completeHandler() {
        alert(":)");
      },
      data: formData,
      cache: false,
      contentType: false,
      processData: false
    });
  });

  $("#send-command").click(function() {
    taskId = $("#task-id").val();
    command = $("#command").val();
    if(taskId == "" || command == ""){
      alert("Task Id and Command cannot be empty.");
      return;
    }
    var socket = new WebSocket("ws://localhost:5056/run");
    socket.onopen = function(){
      console.log("Socket opened");
      $("#send-command").prop('disabled', true);
      $("#command").val("")
      socket.send(taskId + " " + command);
    }
    socket.onmessage = function(msg){
      $("#command-area").val($("#command-area").val() + msg.data)
    }
    socket.onclose = function(){
      console.log("Socket closed")
        $("#send-command").prop('disabled', false);
    }
  })

  $("#generate-random-string").click(function() {
    var ret = "";
    var seed = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    for(var i=0;i<20;i++){
      ret += seed[parseInt(Math.random()*seed.length)]
    }
    $("#task-id").val(ret)

  })
})
</script>
